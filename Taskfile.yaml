version: "3"
vars:
  SCRATCH_EDITOR_VERSION: v12.0.1
  DPRINT_VERSION: 0.48.0

tasks:
  install:
    cmds:
      - curl -fsSL https://dprint.dev/install.sh | sh -s {{ .DPRINT_VERSION }}
      - mkdir -p .bin && cp $HOME/.dprint/bin/dprint .bin/dprint # workaround for local install

  fmt:
    desc: Run format
    cmds:
      - ${PWD}/.bin/dprint fmt

  fmt:check:
    desc: Check format
    cmds:
      - ${PWD}/.bin/dprint check

  scratch:init:
    cmds:
      - rm -rf scratch-editor
      - git clone --depth 1 --branch {{ .SCRATCH_EDITOR_VERSION }}  https://github.com/scratchfoundation/scratch-editor.git
      - cd scratch-editor && npm install
      - cd scratch-editor && npm run build
      - task scratch:patch

  scratch:patch:
    cmds:
      - cd scratch-editor/packages/scratch-gui && node ../../../scratch-arduino-extensions/scripts/patch-gui.js

  scratch:local:start:
    dir: scratch-editor
    cmds:
      - npm start --workspace @scratch/scratch-gui

  app:build:
    desc: "Copy app files (python, assets, app.yaml) to a build directory"
    cmds:
      - rm -rf build/scratch-arduino-app/
      - mkdir -p build/scratch-arduino-app
      - cp ./app.yaml build/scratch-arduino-app/app.yaml
      - cp -r ./sketch build/scratch-arduino-app/sketch
      - cp -r ./python build/scratch-arduino-app/python
      - cp -r ./certs build/scratch-arduino-app/certs
      - task scratch:build
      - mkdir -p build/scratch-arduino-app/assets
      - cp scratch-editor/packages/scratch-gui/build/index.html build/scratch-arduino-app/assets/index.html
      - cp scratch-editor/packages/scratch-gui/build/gui.js build/scratch-arduino-app/assets/gui.js
      - mkdir -p build/scratch-arduino-app/assets/static
      - cp -r scratch-editor/packages/scratch-gui/build/static/blocks-media  build/scratch-arduino-app/assets/static/blocks-media

  scratch:build:
    desc: "Build Scratch GUI files"
    dir: scratch-editor/packages/scratch-gui
    cmds:
      - npm run build:dev --workspace @scratch/scratch-gui

  board:app:upload:
    desc: "Upload zip file to Arduino board, unzip and deploy to /home/arduino/ArduinoApps"
    cmds:
      - task app:zip
      - |
          ZIP_FILE=$(ls -t build/scratch-arduino-app-*.zip 2>/dev/null | head -n1)
          if [ -z "$ZIP_FILE" ]; then
            echo "No zip file found. Run 'task app:zip' first."
            exit 1
          fi
          adb push "$ZIP_FILE" /tmp/
          ZIP_BASENAME=$(basename "$ZIP_FILE")
          adb shell "cd /tmp && unzip -o $ZIP_BASENAME && mkdir -p /home/arduino/ArduinoApps && rm -rf /home/arduino/ArduinoApps/scratch-arduino-app && mv scratch-arduino-app /home/arduino/ArduinoApps/ && rm $ZIP_BASENAME"
          echo "App deployed to /home/arduino/ArduinoApps/scratch-arduino-app"

  app:zip:
    desc: "Create a zip file with version (defaults to git commit hash)"
    vars:
      APP_VERSION:
        sh: echo "${APP_VERSION:-$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')}"
    cmds:
      - |
          if [ ! -d "build/scratch-arduino-app" ]; then
            echo "Build folder does not exist. Run 'task app:build' first."
            exit 1
          fi
      - echo "Creating zip with version {{.APP_VERSION}}"
      - cd build && zip -r scratch-arduino-app-{{.APP_VERSION}}.zip scratch-arduino-app && cd ..

  python:watch:
    desc: "Watch Python folder for changes and auto-upload/restart"
    cmds:
      - echo "ğŸ‘€ Watching python/ folder for changes..."
      - echo "Press Ctrl+C to stop watching"
      - |
        # Check if inotify-tools is available
        if ! command -v inotifywait &> /dev/null; then
           echo "âŒ inotifywait not found. Please install inotify-tools manually"
           exit 1
        fi
      - |
        while true; do
          echo "ğŸ” Waiting for changes in python/ folder..."

          # Watch for modify, create, delete, move events in python folder
          inotifywait -r -e modify,create,delete,move python/ 2>/dev/null || {
            echo "âŒ inotifywait failed"
            sleep 2
            continue
          }

          echo "ğŸ“ Change detected in python/ folder!"
          echo "â³ Waiting 1 second for file writes to complete..."
          sleep 1

          echo "ğŸš€ Uploading and restarting..."
          task python:upload-and-restart || {
            echo "âŒ Upload/restart failed, continuing to watch..."
            continue
          }

          echo "âœ… Upload and restart completed!"
          echo "---"
        done

  python:upload-and-restart:
    desc: "Upload Python files and restart container"
    cmds:
      - echo "Uploading Python files..."
      - adb push ./python/ /home/arduino/ArduinoApps/scratch-arduino-app/
      - echo "Python files uploaded successfully"
      - echo "ğŸ” Searching for Arduino app container..."
      - |
        CONTAINER_ID=$(adb shell "docker ps -q --filter 'ancestor=ghcr.io/arduino/app-bricks/python-apps-base:0.5.0'")
        if [ -n "$CONTAINER_ID" ]; then
          echo "ğŸ“¦ Found container: $CONTAINER_ID"
          adb shell "docker restart $CONTAINER_ID"
          echo "âœ… Container restarted successfully"
        else
          echo "âš ï¸  No running container found with image ghcr.io/arduino/app-bricks/python-apps-base"
        fi

  sketch:monitor:
    desc: "Open serial monitor for Arduino debugging"
    cmds:
      - echo "ğŸ“º Opening serial monitor (Press Ctrl+C to exit)..."
      - |
        echo "ğŸ” Detecting Arduino board..."
        BOARD_JSON=$(arduino-cli board list --json 2>/dev/null)
        if [ $? -ne 0 ] || [ -z "$BOARD_JSON" ]; then
          echo "âŒ Failed to detect boards. Make sure arduino-cli is installed and Arduino is connected."
          exit 1
        fi

        # Use jq for proper JSON parsing if available, otherwise fallback
        if command -v jq &> /dev/null; then
          # Only use serial ports (USB connection)
          PORT_ADDRESS=$(echo "$BOARD_JSON" | jq -r '
            .detected_ports[] |
            select(.port.protocol == "serial") |
            .port.address' 2>/dev/null | head -1)
        else
          # Fallback to grep method for serial ports only
          PORT_ADDRESS=$(echo "$BOARD_JSON" | grep -A10 '"protocol":"serial"' | grep '"address"' | head -1 | cut -d'"' -f4)
        fi

        if [ -z "$PORT_ADDRESS" ] || [ "$PORT_ADDRESS" = "null" ]; then
          echo "âŒ No Arduino boards detected. Make sure your Arduino UNO Q is connected."
          exit 1
        fi
        echo "ğŸ“¡ Connecting to Arduino at: $PORT_ADDRESS"
        arduino-cli monitor -p "$PORT_ADDRESS"

  sketch:watch:
    desc: "Watch sketch folder for changes and auto-compile/upload"
    cmds:
      - echo "ğŸ‘€ Watching sketch/ folder for changes..."
      - echo "Press Ctrl+C to stop watching"
      - |
        if ! command -v arduino-cli &> /dev/null; then
          echo "âŒ arduino-cli not found. Installing..."
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          echo "âœ… arduino-cli installed. Please restart this task."
          exit 1
        fi
      - |
        if ! command -v inotifywait &> /dev/null; then
          echo "âŒ inotifywait not found. Please install inotify-tools manually"
          exit 1
        fi
      - |
        # Start watching for changes in sketch folder
        while true; do
          echo "ğŸ” Waiting for changes in sketch/ folder..."

          # Watch for modify, create, delete events in sketch folder
          inotifywait -r -e modify,create,delete sketch/ --include '\.(ino|cpp|h|c)$' 2>/dev/null || {
            echo "âŒ inotifywait failed, falling back to polling..."
            sleep 2
            continue
          }

          echo "ğŸ“ Arduino code change detected!"
          echo "â³ Waiting 1 second for file writes to complete..."
          sleep 1

          echo "ğŸ”¨ Compiling and uploading..."
          if task sketch:compile-and-upload; then
            echo "ğŸ“º You can run 'task sketch:serial' in another terminal to see serial output"
          else
            echo "âŒ Compilation or upload failed, continuing to watch..."
          fi

          echo "---"
        done

  sketch:compile-and-upload:
    desc: "Compile and upload Arduino sketch"
    cmds:
      - echo "ğŸ”¨ Compiling Arduino sketch..."
      - |
        if [ ! -d "sketch" ]; then
          echo "âŒ sketch/ folder not found"
          exit 1
        fi
      - arduino-cli compile  --build-path .cache -b arduino:zephyr:unoq sketch/ --profile default
      - echo "âœ… Compilation completed successfully"
      - echo "ğŸ“¤ Uploading Arduino sketch to board..."
      - |
        echo "ğŸ” Detecting Arduino boards..."
        BOARD_JSON=$(arduino-cli board list --json 2>/dev/null)
        if [ $? -ne 0 ] || [ -z "$BOARD_JSON" ]; then
          echo "âŒ Failed to detect boards. Make sure arduino-cli is installed and Arduino is connected."
          exit 1
        fi

        # Check if jq is available, if not install it
        if ! command -v jq &> /dev/null; then
          echo "ğŸ“¦ Installing jq for JSON parsing..."
          sudo apt-get update && sudo apt-get install -y jq 2>/dev/null || {
            echo "âŒ Could not install jq. Using fallback method..."
            # Fallback to grep method for the nested structure
            PORT_ADDRESS=$(echo "$BOARD_JSON" | grep -A10 '"port"' | grep '"address"' | head -1 | cut -d'"' -f4)
            BOARD_FQBN=$(echo "$BOARD_JSON" | grep -A5 '"matching_boards"' | grep '"fqbn"' | head -1 | cut -d'"' -f4)
          }
        fi

        # Use jq for proper JSON parsing if available
        if command -v jq &> /dev/null; then
          # Only use serial ports (USB connection)
          PORT_ADDRESS=$(echo "$BOARD_JSON" | jq -r '
            .detected_ports[] |
            select(.port.protocol == "serial") |
            .port.address' 2>/dev/null | head -1)

          BOARD_FQBN=$(echo "$BOARD_JSON" | jq -r '
            .detected_ports[] |
            select(.port.protocol == "serial") |
            .matching_boards[0].fqbn' 2>/dev/null | head -1)
        fi

        if [ -z "$PORT_ADDRESS" ] || [ "$PORT_ADDRESS" = "null" ]; then
          echo "âŒ No Arduino boards detected. Make sure your Arduino UNO Q is connected."
          echo "ğŸ’¡ Run 'arduino-cli board list' to see available boards"
          exit 1
        fi

        echo "ğŸ“¡ Found Arduino board at: $PORT_ADDRESS (FQBN: $BOARD_FQBN)"
        arduino-cli upload -p "$PORT_ADDRESS" -b arduino:zephyr:unoq:flash_mode=ram sketch/ --input-dir .cache
      - echo "âœ… Upload completed successfully"
